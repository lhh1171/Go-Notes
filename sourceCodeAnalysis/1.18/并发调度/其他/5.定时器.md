# 定时器

标准库 `time.Timer` 的内部实现。

```go
// runtime2.go

type p struct {
    
    // Actions to take at some time. 
    timers []*timer

    // Number of timers in P's heap.
    numTimers uint32

    // The when field of the first entry on the timer heap.
    timer0When uint64
    
    // Number of timerDeleted timers in P's heap.
    deletedTimers uint32    
}
```

```go
// time.go

type timer struct {
    
    // If this timer is on a heap, which P's heap it is on.
    pp puintptr

    // Timer wakes up at when, and then at when+period, ... (period > 0 only)
    // each time calling f(arg, now) in the timer goroutine, so f must be
    // a well-behaved function and not block.
    //
    // when must be positive on an active timer.
    
    when   int64
    period int64
    f      func(any, uintptr)
    arg    any
    seq    uintptr

    // What to set the when field to in timerModifiedXX status.
    nextwhen int64

    // The status field holds one of the values below.
    status uint32
}
```

&nbsp;

## 添加

将定时器添加到所有 `P.timers` 最小堆(`timer.when`) 中。

```go
// time.go

// addtimer adds a timer to the current P.
// This should only be called with a newly created timer.
// That avoids the risk of changing the when field of a timer in some P's heap,
// which could cause the heap to become unsorted.

func addtimer(t *timer) {

    t.status = timerWaiting
    when := t.when
    pp := getg().m.p.ptr()

    // 清理堆头部，将新定时器加入堆。
    cleantimers(pp)
    doaddtimer(pp, t)

    wakeNetPoller(when)
}
```

必要时，中断轮询等待(`epollwait`)，让调度循环(schedule)及时检查(checkTime)是否有定时器到期。

```go
// proc.go

// wakeNetPoller wakes up the thread sleeping in the network poller if it isn't
// going to wake up before the when argument; or it wakes an idle P to service
// timers and the network poller if there isn't one already.

func wakeNetPoller(when int64) {
    if atomic.Load64(&sched.lastpoll) == 0 {
        pollerPollUntil := int64(atomic.Load64(&sched.pollUntil))
        if pollerPollUntil == 0 || pollerPollUntil > when {
            netpollBreak()
        }
    }
}
```
